name: cd
on:
  push:
    branches:
      - main

jobs:
  build_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: install
        working-directory: transaction-validator
        run: npm install --no-audit --no-fund
      - name: unit tests
        working-directory: transaction-validator
        run: npm test

  docker:
    needs: build_test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: ./transaction-validator
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/transaction-validator:${{ github.sha }}

  deploy_canary:
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      - name: write kubeconfig
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG" > $HOME/.kube/config
      - name: render manifests
        run: |
          sed -i "s|ghcr.io/your-org/transaction-validator:latest|ghcr.io/${{ github.repository_owner }}/transaction-validator:${{ github.sha }}|" deploy/k8s/deployment.yaml
      - name: apply
        run: |
          kubectl apply -f deploy/k8s/deployment.yaml
          kubectl apply -f deploy/k8s/service.yaml
          kubectl apply -f deploy/k8s/ingress.yaml
          kubectl apply -f deploy/k8s/ingress-canary.yaml
      - name: set 5 percent traffic
        run: NS=default WEIGHT=5 bash scripts/canary_promote.sh

  validate_canary:
    needs: deploy_canary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6@v1
      - name: run k6 5 percent
        env:
          CANARY_HOST: ${{ secrets.CANARY_HOST }}
        run: k6 run tests/k6-canary.js

  promote_20:
    needs: validate_canary
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - uses: actions/checkout@v4
      - name: setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      - name: write kubeconfig
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG" > $HOME/.kube/config
      - name: set 20 percent traffic
        run: NS=default WEIGHT=20 bash scripts/canary_promote.sh
      - name: k6 20 percent
        uses: grafana/setup-k6@v1
      - name: run k6
        env:
          CANARY_HOST: ${{ secrets.CANARY_HOST }}
        run: k6 run tests/k6-canary.js

  promote_50:
    needs: promote_20
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - uses: actions/checkout@v4
      - name: setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      - name: write kubeconfig
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG" > $HOME/.kube/config
      - name: set 50 percent traffic
        run: NS=default WEIGHT=50 bash scripts/canary_promote.sh
      - name: k6 50 percent
        uses: grafana/setup-k6@v1
      - name: run k6
        env:
          CANARY_HOST: ${{ secrets.CANARY_HOST }}
        run: k6 run tests/k6-canary.js

  finalize_100:
    needs: promote_50
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - uses: actions/checkout@v4
      - name: setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      - name: write kubeconfig
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG" > $HOME/.kube/config
      - name: set 100 percent traffic
        run: NS=default WEIGHT=100 bash scripts/canary_promote.sh
      - name: remove canary ingress
        run: kubectl delete ingress transaction-validator-canary || true

  rollback:
    needs: [validate_canary, promote_20, promote_50]
    runs-on: ubuntu-latest
    if: ${{ failure() }}
    steps:
      - name: setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      - name: write kubeconfig
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG" > $HOME/.kube/config
      - name: rollback deployment
        run: kubectl rollout undo deployment transaction-validator
